
## Setup virtual environment
python3.10 -m venv .venv310
source .venv310/bin/activate
pip install -r requirements.txt

## create firebase projects
- use the firebase console to create a firebase project.
- update Makefile with the project id. You may choose to create a production environment only (PROD) or an additional dev environment (DEV)

project-annotation-web-ui/Makefile
```
PROD_PROJECT_NAME=soe-stanford-friallel-adlm
DEV_PROJECT_NAME=soe-stanford-friallel-adlm-dev
```

# create firestore realtime database
- Select 'Start in locked mode'

# Setup firestore database
generate fb service account
mkdir keys
copy generated key to keys/fbServiceAccountKey-prod.json
create firestore database


# import datasets
make load-cpc-flores-dev
make load-cpc-flores-devtest


# create workflows
make create-translation-workflows-flores-devtest


# deploy ui
cd project-annotation-web-ui
firebase login
make deploy-prod-ui

navigate to project settings apps
create app
update firebvase config

# update firebase firewall rules
```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /annotation-tasks/{task} {
      allow read, write: if request.auth != null;
    }
    match /users/{userId} {
      allow read, write: if request.auth != null;
    }
    match /dataset-cpc-flores-devtest/{task} {
      allow read, write: if request.auth != null;
    }
    match /dataset-cpc-flores-dev/{task} {
      allow read, write: if request.auth != null;
    }
    match /dataset-cpc-nllb-seed/{task} {
      allow read: if request.auth != null;
    }
    match /dataset-ntrex-128/{task} {
      allow read: if request.auth != null;
    }
    match /config/{c} {
      allow read: if request.auth != null;
    }
  }
}
```


# deploy database indices
make deploy-prod-indexes


# configure users
- Primary user records can be found in firebase console under 'authentication'
- For each user to be authorized, create a document in the 'users' collection with a key equal to the User UID generated by firebase authentication.
- User document
```
{
    email: "x.y@z.com",
    name: "Koulako Bala",
    isActiveTranslator: true,
    isActiveVerifier: false,
    translation_from_languages: ['eng_Latn', 'fra_Latn', 'nqo_Nkoo', 'arz_Arab'],
    verifier_level: 1
}
```


# deploy firebase functions
make deploy-prod-functions
The following two functions should appear in your firebase console
- workflowTaskAssignmentAgent (task manager)
- workflowTaskWorker (workflow manager)
- the file functions/.env.prod can be used to configure functions
```
MAX_TASK_ASSIGNMENT_AGE_HOURS=24
USER_TRANSLATION_BUCKET_MAX_SIZE=50
USER_VERIFICATION_BUCKET_MAX_SIZE=50
```

# Starting the workers
- You may choose to let the system bootstrap on its own. The workflow manager runs every 2 hours per default. The task manager runs every 30 minutes by default.
- You may also 'force run' the managers in firebase cloud scheduler. This option may be useful for troubleshooting initial deployments.


# i18 UI Localization
- Add a new UI language
    - in index.html, update the <select data-i18n-switcher /> dropdownlist
    - add a new file under project-annotation-web-ui/public/i18n
- Configure writing direction per language
    - create the 'configurations' collection
    - in this collection, create a 'languages' document with a 'writingDirection' field of type map and of value reflecting your settings. Example:
    {
        nqo_Nkoo: 'rtl',
        ful_Adlm: 'rtl',
        arab_Arab: 'rtl',
        ary_Arab: 'rtl',
        az_Arab: 'rtl',
    }
    - Unless configured otherwise, languages are assumed to be 'ltr' (left to right)